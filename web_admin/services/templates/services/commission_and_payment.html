{% extends "base.html" %}
{% load static %}
{% block sidebar_panel %}
    {% with active_tab='services' %}
        {{ block.super }}
    {% endwith %}
{% endblock sidebar_panel %}

{% block content %}
{% csrf_token %}

<div class="panel mb25">
    <div class="panel-heading">
        <h3>Commission And Payment Method</h3>
    </div>

    <div id="ajax-messages">
        {% for message in messages %}
        <div class="col-xs-12">
            <div class="alert alert-success alert-dismissable" id="msg-add-service">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
                <strong>{{ message|capfirst }}</strong>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="panel-body">
        <div class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-2 control-label">Service name:</label>
                <div class="col-sm-4">
                    <input value="{{ service_id }}" type="text" class="form-control" name="service_name" id="txt_service_name" disabled />
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Command:</label>
                <div class="col-sm-4">
                    <input type="text" value="{{ command_id }}" class="form-control" name="command" id="txt_command" disabled/>
                </div>
            </div>
        </div>

        {% comment %}
        <div class="panel-heading">
            <h4>I. Fee & Bonus</h4>
        </div>

        <div class="form-inline">
            <label class="col-sm-2 control-label">Fee:</label>
            <div class="form-group">
                <div class="col-sm-4">
                    <input value="{{ service_id }}" type="text" class="form-control" name="service_name" id="txt_service_name" disabled />
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-4">
                    <input type="text" value="{{ command_id }}" class="form-control" name="command" id="txt_command" disabled/>
                </div>
            </div>
        </div>
        <br />
        <div class="form-inline">
            <label class="col-sm-2 control-label">Bonus:</label>
            <div class="form-group">
                <div class="col-sm-4">
                    <input value="{{ service_id }}" type="text" class="form-control" name="service_name" id="txt_service_name" disabled />
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-4">
                    <input type="text" value="{{ command_id }}" class="form-control" name="command" id="txt_command" disabled/>
                </div>
            </div>
        </div>
        {% endcomment %}

        <div class="panel-heading">
            <h4>II. Setting Payment & Fee Structure</h4>
        </div>

        <form method="POST" class="form-horizontal" role="form" action="{% url 'services:payment_and_fee_stucture' service_id command_id service_command_id fee_tier_id %}" id="payment_and_fee_stucture_form">

            {% csrf_token %}
            <div class="form-group table-responsive row">
                <table class="table table-bordered table-striped datatable editable-datatable  mb0" id="tbl_setting_payment_fee_structure">
                    <thead>
                    <tr>
                        <th id="lbl_db">Debit/Credit</th>
                        <th id="lbl_actor">Actor</th>
                        <th id="lbl_specific_id">Specific ID</th>
                        <th id="lbl_source_of_fund">Source of Fund</th>
                        <th id="lbl_specific_source">Specific Source of Fund</th>
                        <th id="lbl_from_amount">From Amount</th>
                        <th id="lbl_rate">Rate %</th>
                        <th id="lbl_actions">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for d in data %}
                    <tr id="balance-distribution-{{ d.balance_distribution_id }}" data-url="{% url "services:payment_and_fee_stucture_update" d.balance_distribution_id %}" data-id="{{ d.balance_distribution_id }}">
                        <td class="col-sm-1">{{ d.action_type|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.actor_type|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.specific_actor_id|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.sof_type_id|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.specific_sof|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.amount_type|default_if_none:'' }}</td>
                        <td class="col-sm-2">{{ d.rate|default_if_none:'' }}</td>
                        <td class="col-sm-1">
                            <a class="btn btn-outline btn-xs btn-primary edit text-info small"
                            id="btn_setting_payment_fee_structure_edit"
                            role="button">Edit</a>
                            <span type="button" class="btn btn-outline btn-xs btn-primary"
                            id="btn_setting_payment_fee_structure_delete" class="text-info"
                            role="button"
                            onclick="deleteDistribution('{{ d.balance_distribution_id }}')"
                            class="text-info">
                            <span class="small">Delete</span>
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td class="col-sm-1">
                            <select class="form-control" name="action_type">
                                {% for action_type in choices.action_types %}
                                <option value="{{ action_type.action_type }}">{{ action_type.action_type }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="col-sm-1">
                            <select class="form-control" name="actor_type">
                                {% for actor_type in choices.actor_types %}
                                <option value="{{ actor_type.actor_type }}">{{ actor_type.actor_type }}</option>
                                {% endfor %}
                            </select>
                        <td class="col-sm-1"></td>
                        <td class="col-sm-1">
                            <select class="form-control" name="sof_type_id">
                                {% for sof_type in choices.sof_types %}
                                <option value="{{ sof_type.sof_type_id }}">{{ sof_type.sof_type }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="col-sm-1"><input class="form-control" name="specific_sof"></input></td>
                        <td class="col-sm-1">
                            <select class="form-control" name="amount_type">
                                {% for amount_type in choices.amount_types %}
                                <option value="{{ amount_type.amount_type }}">{{ amount_type.amount_type }}</option>
                                {% endfor %}
                            </select>
                        <td class="col-sm-2"><input class="form-control" name="rate" required></input></td>
                        <td></td>
                    </tr>
                </table>
            </div>


            <div class="form-group pull-right">
                <a href="#">
                    <input id="btn_setting_payment_fee_strucure_add" class="btn btn-success" type="submit" value="Add"/>
                </a>
            </div>
        </form>

        <div class="panel-heading">
            <h4>III. Setting Bonus</h4>
        </div>

        <form method="POST" class="form-horizontal" role="form"
              action="{% url 'services:setting_bonus' service_id command_id service_command_id fee_tier_id %}">

            {% csrf_token %}
            <div class="form-group table-responsive row">
                <table class="table table-bordered table-striped mb0" id="tbl_setting_bonus">
                    <thead>
                    <tr>
                        <th id="lbl_db">Debit/Credit</th>
                        <th id="lbl_actor">Actor</th>
                        <th id="lbl_specific_id">Specific ID</th>
                        <th id="lbl_source_of_fund">Source of Fund</th>
                        <th id="lbl_specific_source">Specific Source of Fund</th>
                        <th id="lbl_from_amount">Amount</th>
                        <th id="lbl_rate">Rate %</th>
                        <th id="lbl_actions">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for d in bonus %}
                    <tr role="row">
                        <td class="col-sm-1">{{ d.action_type|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.actor_type|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.specific_actor_id|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.sof_type_id|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.specific_sof|default_if_none:'' }}</td>
                        <td class="col-sm-1">{{ d.amount_type|default_if_none:'' }}</td>
                        <td class="col-sm-2">{{ d.rate|default_if_none:'' }}</td>
                        <td class="col-sm-1">
                            <a type="button" class="btn btn-outline btn-xs btn-primary"
                               role="button"
                               id="btn_setting_bonus_edit" class="text-info"
                               href="#" role="button"
                               class="text-info">
                                <span class="small">Edit</span>
                            </a>
                            {% comment %}
                            <a type="button" class="btn btn-outline btn-xs btn-primary"
                               role="button"
                               id="btn_setting_bonus_delete" class="text-info"
                               href="#" role="button"
                               class="text-info">
                                <span class="small">Delete</span>
                            </a>
                            {% endcomment %}
                        </td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td class="col-sm-1">
                            <select class="form-control" name="action_type" id="ddl_setting_bonus_dc">
                                {% for action_type in choices.action_types %}
                                <option value="{{ action_type.action_type }}">{{ action_type.action_type }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="col-sm-1">
                            <select class="form-control" name="actor_type" id="ddl_setting_bonus_actor">
                                {% for actor_type in choices.actor_types %}
                                <option value="{{ actor_type.actor_type }}">{{ actor_type.actor_type }}</option>
                                {% endfor %}
                            </select>
                        <td class="col-sm-1"></td>
                        <td class="col-sm-1">
                            <select class="form-control" name="sof_type_id" id="ddl_setting_bonus_src_fund">
                                {% for sof_type in choices.sof_types %}
                                <option value="{{ sof_type.sof_type_id }}">{{ sof_type.sof_type }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="col-sm-1"><input class="form-control" id="txt_setting_bonus_spec_src_fund"
                                                                                         name="specific_sof"></input>
                        </td>
                        <td class="col-sm-1">
                            <select class="form-control" name="amount_type" id="ddl_setting_bonus_amount">
                                {% for amount_type in choices.amount_types %}
                                <option value="{{ amount_type.amount_type }}">{{ amount_type.amount_type }}</option>
                                {% endfor %}
                            </select>
                        <td class="col-sm-2"><input id="txt_setting_bonus_rate" class="form-control" name="rate"
                                                                                required></input></td>
                        <td></td>
                    </tr>
                </table>
            </div>

            <div class="form-group pull-right">
                <a href="#">
                    <input id="btn_setting_bonus_add" class="btn btn-success" type="submit" value="Add"/>
                </a>
            </div>
        </form>

    </div>
</div>

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

<script>

function deleteDistribution(distributionId) {
    var url = $('#payment_and_fee_stucture_form').attr('action') + distributionId;
    $.ajax({
        url: url,
        type: "DELETE",
        dataType: "json",
        beforeSend: function (xhr) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
        },
        success: function () {
            $('#balance-distribution-' + distributionId).remove();
            addMessage("Deleted data successfully");
        },
        error: function() {
            addMessage("Delete failed!");
        }
    });
}

function addMessage(message) {
    $("#ajax-messages").empty().append(
    '<div class="col-xs-12">' +
        '<div class="alert alert-success alert-dismissable" id="msg-add-service">' +
            '<a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>' +
            '<strong>' + message + '</strong>' +
        '</div>' +
    '</div>')
}

function onInlineSetupDataTable() {

    var nEditing = null;
    var oTable;

    function restoreRow(oTable, nRow) {
        var aData = oTable.fnGetData(nRow);
        var jqTds = $('>td', nRow);

        for (var i = 0, iLen = jqTds.length; i < iLen; i++) {
            oTable.fnUpdate(aData[i], nRow, i, false);
        }

        oTable.fnDraw();
    }

    function editRow(oTable, nRow) {
        var aData = oTable.fnGetData(nRow);
        var jqTds = $('>td', nRow);
        var htmlSelected = '';

        // Master: ActionTypes Dropdown
        var htmlDDActionTypes = '';
        var action_types = {{ choices.action_types|safe }};
        jQuery.each(action_types, function() {
            if (aData[0].toLowerCase() == this.action_type.toLowerCase()) {
                htmlSelected = ' selected=\"selected\" ';
            } else {
                htmlSelected = ' ';
            }

            htmlDDActionTypes += '<option value="' + this.action_type_id + '"' + htmlSelected + '>' + this.action_type + '</option>';
        });

        // Master: Actors Dropdown
        var htmlDDActors = '';
        var actor_types = {{ choices.actor_types|safe }};
        jQuery.each(actor_types, function() {
            if (aData[1].toLowerCase() == this.actor_type.toLowerCase()) {
                htmlSelected = ' selected=\"selected\" ';
            } else {
                htmlSelected = ' ';
            }

            htmlDDActors += '<option value="' + this.actor_type_id + '"' + htmlSelected + '>' + this.actor_type + '</option>';
        });

        // Master: SOFTypes Dropdown
        var htmlDDSOFTypes = '';
        var sof_types = {{ choices.sof_types|safe }};
        jQuery.each(sof_types, function() {
            if (aData[3].toLowerCase() == this.sof_type.toLowerCase()) {
                htmlSelected = ' selected=\"selected\" ';
            } else {
                htmlSelected = ' ';
            }

            htmlDDSOFTypes += '<option value="' + this.sof_type_id + '"' + htmlSelected + '>' + this.sof_type + '</option>';
        });

        // Master: AmountTypes Dropdown
        var htmlDDAmountTypes = '';
        var amount_type = {{ choices.amount_types|safe }};
        jQuery.each(amount_type, function() {
            if (aData[5].toLowerCase() == this.amount_type.toLowerCase()) {
                htmlSelected = ' selected=\"selected\" ';
            } else {
                htmlSelected = ' ';
            }

            htmlDDAmountTypes += '<option value="' + this.amount_type_id + '"' + htmlSelected + '>' + this.amount_type + '</option>';
        });

        jqTds[0].innerHTML = '<select type=\'text\' class=\'form-control\' name=\'action_type\'>' + htmlDDActionTypes + '</select>';
        jqTds[1].innerHTML = '<select type=\'text\' class=\'form-control\' name=\'actor_type\'>' + htmlDDActors + '</select>';
        jqTds[2].innerHTML = '';
        jqTds[3].innerHTML = '<select type=\'text\' class=\'form-control\' name=\'sof_type_id\'>' + htmlDDSOFTypes + '</select>';
        jqTds[4].innerHTML = '<input type=\'text\' class=\'form-control\' name=\'specific_sof\' value=\'' + aData[4] + '\'>';
        jqTds[5].innerHTML = '<select type=\'text\' class=\'form-control\' name=\'amount_type\'>' + htmlDDAmountTypes + '</select>';
        jqTds[6].innerHTML = '<input type=\'text\' class=\'form-control\' name=\'rate\' required value=\'' + aData[6] + '\'>';

        // Action Buttons
        var htmlButtonSave = '<a class=\'edit btn btn-outline btn-xs btn-primary text-info small\' role=\'button\' id=\'payment_and_fee_stucture_btn_save\'>Save</a>';
        var htmlButtonCancel = '<a class=\'cancel btn btn-outline btn-xs btn-primary text-info small\' role=\'button\'>Cancel</a>';

        jqTds[7].innerHTML = htmlButtonSave + htmlButtonCancel;

        onBindingButtonsCancelEvent();
    }

    function saveRow(oTable, nRow) {
        var jqInputs = $('input', nRow);
        var jqSelects = $('select', nRow);
        var balance_distribution_id = $(nRow).data('id');

        oTable.fnUpdate($(jqSelects[0]).find(":selected").html(), nRow, 0, false);      // Action_Type
        oTable.fnUpdate($(jqSelects[1]).find(":selected").html(), nRow, 1, false);      // Actor_Type
                                                                                        // Specific ID
        oTable.fnUpdate($(jqSelects[2]).find(":selected").val(), nRow, 3, false);       // Sof Type ID
        oTable.fnUpdate(jqInputs[0].value, nRow, 4, false);                             // Specific SOF
        oTable.fnUpdate($(jqSelects[3]).find(":selected").html(), nRow, 5, false);      // Amount Type
        oTable.fnUpdate(jqInputs[1].value, nRow, 6, false);                             // Rate

        var htmlButtonEdit = '<a class=\'edit btn btn-outline btn-xs btn-primary edit text-info small\' role=\'button\'>Edit</a>';
        var htmlButtonDelete = '' +
            '<span type=\'button\' class=\'btn btn-outline btn-xs delete btn-primary text-info\' role=\'button\' id=\'btn_setting_payment_fee_structure_delete\' onclick=\'deleteDistribution(' + balance_distribution_id + ')\'>' +
            '<span class=\'small\'>' +
            'Delete' +
            '</span>' +
            '</span>';

        oTable.fnUpdate(htmlButtonEdit + htmlButtonDelete, nRow, 7, false);
        oTable.fnDraw();
    }

    function saveRowToServer(oTable, nRow) {
        var jqInputs = $('input', nRow);
        var jqSelects = $('select', nRow);
        var url = $(nRow).data('url');

        // Request to server
        $.ajax({
            url: url,
            type: "POST",
            data: {
                "fee_tier_id": {{ fee_tier_id  }},
                "action_type": $(jqSelects[0]).find(":selected").html(),
                "actor_type": $(jqSelects[1]).find(":selected").html(),
                // 2 = empty data
                "sof_type_id": $(jqSelects[2]).find(":selected").val(),
                "specific_sof": jqInputs[0].value,
                "amount_type": $(jqSelects[3]).find(":selected").html(),
                "rate": jqInputs[1].value
            },
            dataType: "json",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            success: function (response) {

                var data = JSON.stringify(response);
                var json = $.parseJSON(data);
                console.log('JSON: ');
                console.log(json);

                if (json.status.code == 'success') {
                    console.log('Saved row data');
                    saveRow(oTable, nRow);
                    addMessage("Edit successfully!");
                } else {
                    console.log('Error adding row data');
                    addMessage("Edit error!");
                }

            },
            error: function (err) {
                var json = JSON.stringify(err);
                console.log('JSON: ');
                console.log(json);

                addMessage("Edit error!");
            }
        });
    }

    oTable = $('#tbl_setting_payment_fee_structure').dataTable({
        "searching":  false,
        "paging":   false,
        "ordering": false,
        "info":     false
    });

    function onBindingButtonsCancelEvent() {
        $('#tbl_setting_payment_fee_structure').on('click', 'a.cancel', function (e) {
            e.preventDefault();

            /* Get the row as a parent of the link that was clicked on */
            var nRow = $(this).parents('tr')[0];
            {#            console.log(nRow);#}

            restoreRow(oTable, nEditing);
            // editRow(oTable, nRow);
            // nEditing = nRow;

            console.log("0 - cancel");
            onBindingButtonsEditEvent();
        });
    }

    function onBindingButtonsEditEvent() {
        console.log("-1");

        $('#tbl_setting_payment_fee_structure').on('click', 'a.edit', function (e) {
            e.preventDefault();

            /* Get the row as a parent of the link that was clicked on */
            var nRow = $(this).parents('tr')[0];

            if (nEditing !== null && nEditing !== nRow) {
                /* Currently editing - but not this row - restore the old before continuing to edit mode */
                restoreRow(oTable, nEditing);
                editRow(oTable, nRow);
                nEditing = nRow;
            } else if (nEditing === nRow && this.innerHTML === 'Save') {
                /* Editing this row and want to save it */
                saveRowToServer(oTable, nEditing);
                nEditing = null;
            } else {
                console.log("3");
                /* No edit in progress - let's start one */
                editRow(oTable, nRow);
                nEditing = nRow;
            }

            return false;
        });
    }

    onBindingButtonsEditEvent();
}

$( document ).ready(function() {
    'use strict';
    onInlineSetupDataTable();
});

</script>

{% endblock %}
