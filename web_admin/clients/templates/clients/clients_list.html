{% extends "base.html" %}
{% load static %}

{% block body_stylesheet %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'vendor/sweetalert/lib/sweet-alert.css' %}">
{% endblock %}

{% block content %}

<div class="panel mb25">
    <div class="panel-heading border mb15">
        <h3>Clients</h3>
    </div>
    <div class="pull-right mr15 text-right">
        <a href="{% url 'clients:create-client' %}">
            <input id="client-btn-create" class="btn btn-success btn-block btn-sm text-left no-print mb15" type="button"
                   value="Create"/>
        </a>
    </div>
    {% if msg is not None %}
    <div class="col-xs-12 mb5">
        <div class="alert alert-success alert-dismissable" id="msg-update-client">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
            <strong>{{ msg }}</strong>
        </div>
    </div>
    {% endif %}
    {% if add_client_msg is not None %}
    <div class="col-xs-12 mb5">
        <div class="alert alert-success alert-dismissable" id="msg-update-client">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
            <strong>{{ add_client_msg }}</strong>
        </div>
    </div>
    {% endif %}
    <div class="col-xs-12 mb5">
        <div class="alert alert-success alert-dismissable" hidden id="alert-success-client">
            <button type="button" class="close" onclick="$('.alert').hide()">×</button>
            <strong id="alert-success-msg"></strong>
        </div>
    </div>
    <div class="col-xs-12 mb5">
        <div class="alert alert-danger alert-dismissable" hidden id="alert-error">
            <button type="button" class="close" onclick="$('.alert').hide()">×</button>
            <strong id="alert-error-msg"></strong>
        </div>
    </div>
    <div class="panel-body">
        <div class="table-responsive">
            <table class="table table-bordered table-striped mb0">
                <thead>
                <tr>
                    <th>Client Id</th>
                    <th>Client Name</th>
                    <th>Created At</th>
                    <th>Updated At</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for client in data %}
                <tr id="row-{{ client.client_id }}">
                    {% if not client.is_deleted %}
                    <td class="col-sm-2">
                        <a class="client-details-link {{ client.is_deleted|yesno:" text,no-hidden" }}"
                        id="{{ client.client_id }}" class="text-info"
                        href="{% url 'clients:client-detail' client.client_id %}">
                        {{ client.client_id }}
                        </a>
                    </td>
                    <td class="col-sm-2">{{ client.client_name|default_if_none:'' }}</td>
                    <td class="col-sm-2">{{ client.created_timestamp|default_if_none:'' }}</td>
                    <td class="col-sm-2">{{ client.last_updated_timestamp|default_if_none:'' }}</td>
                    <td class="col-sm-3">
                        <div id="client-btn-group-{{ client.client_id }}">
                            <div class="btn-group mb5">
                                <button type="button"
                                        class="btn btn-primary btn-outline btn-xs {{ client.is_deleted|yesno:"hidden,no-hidden" }}"
                                id="client-btn-regenerate-{{ client.client_id }}"
                                data-url="{% url 'clients:regenerate-client-secret' client.client_id %}"
                                onClick="regenerate('{{ client.client_id }}')">
                                <span class="small">Regenerate</span>
                                </button>
                                <a type="button"
                                   class="btn btn-primary btn-outline btn-xs {{ client.is_deleted|yesno:"hidden,no-hidden" }}"
                                {{ client.is_deleted|yesno:"disable=true, disable=false" }}
                                role="button"
                                id="client-btn-update-{{ client.client_id }}" class="text-info"
                                href="{% url 'clients:client-info' client.client_id %}" role="button"
                                id="client-btn-update-{{ client.client_id }}" class="text-info">
                                <span class="small">Update</span>
                                </a>
                            </div>
                            <div class="btn-group mb5">
                                <button type="button" {{ client.is_deleted|yesno:"disable=true, disable=false" }}
                                class="btn btn-danger btn-outline btn-xs {{ client.is_deleted|yesno:"hidden,no-hidden"}}"
                                id="client-btn-delete-{{ client.client_id }}"
                                data-url="{% url 'clients:delete-client' client.client_id %}"
                                onclick="delete_client('{{ client.client_id }}')">
                                <span class="small">Delete</span>
                                </button>
                                {% if client.status == 'active' %}
                                <button type="button" {{ client.is_deleted|yesno:"disable=true, disable=false" }}
                                class="btn btn-primary btn-outline btn-xs {{ client.is_deleted|yesno:"hidden,no-hidden" }}"
                                id="client-btn-status-{{ client.client_id }}"
                                data-url="{% url 'clients:suspend-client' client.client_id %}"
                                onClick="suspend('{{ client.client_id }}')">
                                <span class="small">Suspend</span>
                                </button>

                                {% else %}
                                <button type="button" {{ client.is_deleted|yesno:"disable=true, disable=false" }}
                                class="btn btn-info btn-outline btn-xs {{ client.is_deleted|yesno:"hidden,no-hidden" }}"
                                id="client-btn-status-{{ client.client_id }}"
                                data-url="{% url 'clients:activate-client' client.client_id %}"
                                onClick="activate('{{ client.client_id }}')">
                                <span class="small">Activate</span>
                                </button>
                                {% endif %}
                                <a type="button"
                                   class="btn btn-primary btn-outline btn-xs {{ client.is_deleted|yesno:"
                                   hidden,no-hidden" }}"
                                {{ client.is_deleted|yesno:"disable=true, disable=false" }}
                                role="button"
                                id="btn_scopes" class="text-info"
                                href="{% url 'clients:scope-client' client.client_id %}" role="button">
                                <span class="small">Scopes</span>
                                </a>
                            </div>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    function showErrorMessage(msg) {
        console.log('showErrorMessage: ' + msg);
        $("#alert-error-msg").text(msg);
        $("#alert-error").prop("hidden", false);
        $("#alert-error").fadeIn(1000);
        $("html, body").animate({ scrollTop: 0 }, "slow");

    }
    function regenerate(client_id) {

        swal({
                title: "Are you sure you want to regenerate new client secret?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#2ECC71",
                confirmButtonText: "OK",
                cancelButtonText: "Cancel",
                closeOnConfirm: true,
                closeOnCancel: true
            },
            function (isConfirm) {
                if (isConfirm) {
                    console.log(client_id)
                    var url = $("#client-btn-regenerate-" + client_id).data("url");
                    $.ajax({
                        url: url,
                        type: "POST",
                        data: {"csrfmiddlewaretoken": '{{ csrf_token }}'},
                        success: function (response) {
                            if(response.status == 1) {
                                // Logout
                                var url = window.location.origin + "/admin-portal/logout/";
                                window.location.replace(url);
                            } else if(response.status == 2) {
                                // success
                                $("#alert-success-msg").text('Client secret was generated for ' + client_id + ' client ID')
                                $("#alert-success-client").show();
                                setTimeout(function(){
                                  location.reload(true);
                                }, 10000);

                            } else {
                                // Failed
                                showErrorMessage(response.msg);
                            }
                        },
                        error: function () {
                            console.log('error')
                        }
                    });
                }
            });
    }

    function delete_client(client_id) {
        console.log(client_id);
        swal({
                title: "Are you sure you want to delete?",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "OK",
                closeOnConfirm: true
            },
            function () {
                var url = $("#client-btn-delete-" + client_id).data("url");
                console.log(url);
                $.ajax({
                    url: url,
                    type: "POST",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                    },
                    success: function (response) {
                        console.log(response);
                        if(response.status == 1) {
                            // Logout
                            var url = window.location.origin + "/admin-portal/logout/";
                            window.location.replace(url);
                        } else if(response.status == 2) {
                            // success
                            $("#client-btn-delete-" + client_id).hide();
                            $("#alert-success-msg").text('Deleted data successfully')
                            $("#alert-success-client").show();
                            $("#" + "row-" + client_id).remove();
                        } else {
                            // Failed
                            showErrorMessage(response.msg);
                        }
                    },
                    error: function (response) {
                    }
                });
            });
    }

    function suspend(client_id) {
        swal({
                title: "Are you sure you want to suspend?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#2ECC71",
                confirmButtonText: "OK",
                cancelButtonText: "Cancel",
                closeOnConfirm: true,
                closeOnCancel: true
            },
            function (isConfirm) {
                if (isConfirm) {
                    console.log(client_id)
                    var url = '/admin-portal/clients/suspend/' + client_id + '/';
                    console.log(url)
                    $.ajax({
                        url: url,
                        type: "GET",
                        data: {},
                        success: function (response) {
                            if(response.status == 1) {
                                // Logout
                                var url = window.location.origin + "/admin-portal/logout/";
                                window.location.replace(url);
                            } else if(response.status == 2) {
                                // success
                                location.reload(true)
                            } else {
                                // Failed
                                showErrorMessage(response.msg);
                            }
                        },
                        error: function (msg) {
                            console.log('Error suspending the client id' + client_id + msg)
                        }
                    });
                }
            });
    }

    function activate(client_id) {
        swal({
                title: "Are you sure you want to activate?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#2ECC71",
                confirmButtonText: "OK",
                cancelButtonText: "Cancel",
                closeOnConfirm: true,
                closeOnCancel: true
            },
            function (isConfirm) {
                if (isConfirm) {
                    console.log(client_id)
                    var url = '/admin-portal/clients/activate/' + client_id + '/';
                    console.log(url)
                    $.ajax({
                        url: url,
                        type: "GET",
                        data: {},
                        success: function (response) {
                            if(response.status == 1) {
                                // Logout
                                var url = window.location.origin + "/admin-portal/logout/";
                                window.location.replace(url);
                            } else if(response.status == 2) {
                                // success
                                location.reload(true)
                            } else {
                                // Failed
                                showErrorMessage(response.msg);
                            }
                        },
                        error: function (msg) {
                            console.log('Error activating the client id' + client_id + msg)
                        }
                    });
                }
            });
    }


</script>
{% endblock %}

{% block body_js %}
    {{ block.super }}
    <script src="{% static 'vendor/sweetalert/lib/sweet-alert.min.js' %}"></script>
{% endblock %}