{% extends "base.html" %}
{% load static %}
{% block sidebar_panel %}
{% with active_tab='client_list' %}
{{ block.super }}
{% endwith %}
{% endblock sidebar_panel %}
{% block body_stylesheet %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'vendor/sweetalert/lib/sweet-alert.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="panel mb25">
    <div class="panel-heading">
        <h3>Clients</h3>
    </div>
    <div class="pull-right mr15 text-right">
        <a href="{% url 'clients:create-client' %}">
            <input id="client-btn-create" class="btn btn-success btn-block text-left no-print mb15" type="button"
                   value="Create"/>
        </a>

    </div>
    {% if msg is not None %}
    <div class="col-xs-12">
        <div class="alert alert-success alert-dismissable" id="msg-update-client">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
            <strong>{{ msg }}</strong>
        </div>
    </div>
    {% endif %}
    <div class="col-xs-12">
        <div class="alert alert-success alert-dismissable" hidden id="alert-success-client">
            <button type="button" class="close" onclick="$('.alert').hide()">×</button>
            <span id="alert-success-msg"></span>
        </div>
    </div>
    <div class="panel-body">
        <div class="table-responsive">
            <table class="table table-bordered table-striped mb0">
                <thead>
                <tr>
                    <th>Client Id</th>
                    <th>Client Name</th>
                    <th>Created At</th>
                    <th>Updated At</th>
                    <th>Created By</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for client in data %}
                <tr>
                    {% if client.is_deleted %}
                    <td class="col-sm-2">
                        <a class="client-deleted" id="{{ client.client_id }}"
                           href="{% url 'clients:client-detail' client.client_id %}">
                            {{ client.client_id }}
                        </a>
                    </td>
                    {% else %}
                    <td class="col-sm-2">
                        <a class="client-details-link {{ client.is_deleted|yesno:" text,no-hidden" }}"
                        id="{{ client.client_id }}" class="text-info"
                        href="{% url 'clients:client-detail' client.client_id %}">
                        {{ client.client_id }}
                        </a>
                    </td>
                    {% endif %}
                    <td class="col-sm-2">{{ client.client_name|default_if_none:'' }}</td>
                    <td class="col-sm-2">{{ client.created_timestamp|default_if_none:'' }}</td>
                    <td class="col-sm-2">{{ client.last_updated_timestamp|default_if_none:'' }}</td>
                    <td class="col-sm-1">{{ client.last_updated_user_id|default_if_none:'' }}</td>
                    <td class="col-sm-3">
                        <div id="client-btn-group-{{ client.client_id }}">
                            <div class="btn-group mb5">
                                <button type="button"
                                        class="btn btn-outline btn-xs btn-success {{ client.is_deleted|yesno:"
                                        hidden,no-hidden
                                " }}"
                                id="client-btn-regenerate-{{ client.client_id }}"
                                data-url="{% url 'clients:regenerate-client-secret' client.client_id %}"
                                onClick="regenerate('{{ client.client_id }}')">
                                <span class="small">Regenerate</span>
                                </button>
                                <a type="button"
                                   class="btn btn-outline btn-xs btn-primary {{ client.is_deleted|yesno:"
                                   hidden,no-hidden" }}"
                                {{ client.is_deleted|yesno:"disable=true, disable=false" }}
                                role="button"
                                id="client-btn-update-{{ client.client_id }}" class="text-info"
                                href="{% url 'clients:client-info' client.client_id %}" role="button"
                                id="client-btn-update-{{ client.client_id }}" class="text-info">
                                <span class="small">Update</span>
                                </a>
                            </div>
                            <div class="btn-group mb5">
                                <button type="button" {{ client.is_deleted|yesno:
                                "disable=true, disable=false" }}
                                class="btn btn-outline btn-xs btn-danger {{ client.is_deleted|yesno:"hidden,no-hidden"
                                }}"
                                id="client-btn-delete-{{ client.client_id }}"
                                data-url="{% url 'clients:delete-client' client.client_id %}"
                                onclick="delete_client('{{ client.client_id }}')">
                                <span class="small">Delete</span>
                                </button>
                                {% if client.status == 'active' %}
                                <button type="button" {{ client.is_deleted|yesno:
                                "disable=true, disable=false" }}
                                class="btn btn-outline btn-info btn-xs {{ client.is_deleted|yesno:"hidden,no-hidden" }}"
                                id="client-btn-status-{{ client.client_id }}"
                                data-url="{% url 'clients:suspend-client' client.client_id %}"
                                onClick="suspend('{{ client.client_id }}')">
                                <span class="small">Suspend</span>
                                </button>

                                {% else %}
                                <button type="button" {{ client.is_deleted|yesno:
                                "disable=true, disable=false" }}
                                class="btn btn-outline btn-info btn-xs {{ client.is_deleted|yesno:"hidden,no-hidden" }}"
                                id="client-btn-status-{{ client.client_id }}"
                                data-url="{% url 'clients:activate-client' client.client_id %}"
                                onClick="activate('{{ client.client_id }}')">
                                <span class="small">Activate</span>
                                </button>
                                {% endif %}

                                <a type="button"
                                   class="btn btn-outline btn-xs btn-primary {{ client.is_deleted|yesno:"
                                   hidden,no-hidden" }}"
                                {{ client.is_deleted|yesno:"disable=true, disable=false" }}
                                role="button"
                                id="btn_scope_{{ client.client_id }}" class="text-info"
                                href="{% url 'clients:scope-client' client.client_id %}" role="button"
                                id="client-btn-scope-{{ client.client_id }}" class="text-info">
                                <span class="small">Scope</span>
                                </a>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    function regenerate(client_id) {
        swal({
                title: "Are you sure you want to regenerate new client secret?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#2ECC71",
                confirmButtonText: "OK",
                cancelButtonText: "Cancel",
                closeOnConfirm: true,
                closeOnCancel: true
            },
            function (isConfirm) {
                if (isConfirm) {
                    console.log(client_id)
                    var url = $("#client-btn-regenerate-" + client_id).data("url");
                    $.ajax({
                        url: url,
                        type: "POST",
                        data: {"csrfmiddlewaretoken": '{{ csrf_token }}'},
                        success: function (response) {
                            console.log('success')
                            $("#alert-success-msg").text('Client secret was generated for ' + client_id + ' client ID')
                            $("#alert-success-client").show();
                        },
                        error: function () {
                            console.log('error')
                        }
                    });
                }
            });
    }

    function delete_client(client_id) {
        console.log(client_id);
        swal({
                title: "Are you sure you want to delete?",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "OK",
                closeOnConfirm: true
            },
            function () {
                var url = $("#client-btn-delete-" + client_id).data("url");
                console.log(url);
                $.ajax({
                    url: url,
                    type: "POST",
                    dataType: "json",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                    },
                    success: function (response) {
                        console.log(response);
                        if (response["code"] == "success") {
                            $("#client-btn-delete-" + client_id).hide();
                            $("#alert-success-msg").text('Deleted data successfully')
                            $("#alert-success-client").show();
                            $("#" + client_id).removeClass("client-details-link");
                            $("#" + client_id).addClass("client-deleted");
                            $("#client-btn-success-update-" + client_id).addClass("hidden");
                            $("#client-btn-regenerate-" + client_id).addClass("hidden");
                            $("#client-btn-delete-" + client_id).attr("disable", "true");
                            $("#client-btn-success-update-" + client_id).attr("disable", "true");
                            $("#client-btn-update-" + client_id).attr("disable", "true");
                            $("#client-btn-group-" + client_id).addClass("hidden");
                            $("#client-btn-status-" + client_id).attr("disable", "true");
                        }
                    },
                    error: function (response) {
                    }
                });
            });
    }

    function suspend(client_id) {
        swal({
                title: "Are you sure you want to suspend?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#2ECC71",
                confirmButtonText: "OK",
                cancelButtonText: "Cancel",
                closeOnConfirm: true,
                closeOnCancel: true
            },
            function (isConfirm) {
                if (isConfirm) {
                    console.log(client_id)
                    var url = '/admin-portal/clients/suspend/' + client_id + '/';
                    console.log(url)
                    $.ajax({
                        url: url,
                        type: "GET",
                        data: {},
                        success: function (response) {
                            var json = $.parseJSON(response);
                            if (json.status.code == 'success') {
                                console.log('Client status was suspended for ' + client_id + ' client ID')
                                console.log(response)
                                location.reload(true)
                            } else {
                                console.log('Error suspending the client id' + client_id + 'message: ' + json.status.message)
                            }

                        },
                        error: function (msg) {
                            console.log('Error suspending the client id' + client_id + msg)
                        }
                    });
                }
            });
    }

    function activate(client_id) {
        swal({
                title: "Are you sure you want to activate?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#2ECC71",
                confirmButtonText: "OK",
                cancelButtonText: "Cancel",
                closeOnConfirm: true,
                closeOnCancel: true
            },
            function (isConfirm) {
                if (isConfirm) {
                    console.log(client_id)
                    var url = '/admin-portal/clients/activate/' + client_id + '/';
                    console.log(url)
                    $.ajax({
                        url: url,
                        type: "GET",
                        data: {},
                        success: function (response) {
                            var json = $.parseJSON(response);
                            if (json.status.code == 'success') {
                                console.log('Client status was activated for ' + client_id + ' client ID')
                                console.log(response)
                                location.reload(true)
                            } else {
                                console.log('Error activating the client id' + client_id + 'message: ' + json.status.message)
                            }

                        },
                        error: function (msg) {
                            console.log('Error activating the client id' + client_id + msg)
                        }
                    });
                }
            });
    }

</script>
{% endblock %}

{% block body_js %}
    {{ block.super }}
    <script src="{% static 'vendor/sweetalert/lib/sweet-alert.min.js' %}"></script>
{% endblock %}